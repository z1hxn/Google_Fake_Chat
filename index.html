<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Google</title>
  <link rel="icon" href="https://www.google.com/images/branding/googleg/1x/googleg_standard_color_16dp.png">
  <style>
    body{margin:0;font-family:Arial, sans-serif;background:#fff;color:#202124;}
    .topbar{height:48px;display:flex;align-items:center;justify-content:space-between;padding:0 12px;}
    .gmail-link{font-size:14px;color:#5f6368;cursor:pointer;}
    .gmail-link:hover{text-decoration:underline;}
    .profile{width:32px;height:32px;border-radius:50%;background:#4285F4;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:bold;user-select:none;}
    .main{display:flex;flex-direction:column;align-items:center;margin-top:120px;}
    .logo{margin-bottom:24px;}
    .logo img{width:272px;height:auto;}
    .searchbox{width:min(600px,90%);}
    .searchform{display:flex;align-items:center;border:1px solid #dadce0;padding:10px 14px;border-radius:24px;}
    .searchform input{flex:1;border:0;outline:none;font-size:16px;}
    .suggestions {
      margin-top:12px;
      border:1px solid #e8eaed;
      border-radius:8px;
      overflow-y:auto;
      max-height:300px; /* allow scrolling if more messages */
    }
    .sugg-header{padding:8px 14px;font-size:13px;color:#70757a;border-bottom:1px solid #f1f3f4;background:#f8f9fa;}
    .sugg-item{padding:8px 14px;border-bottom:1px solid #f1f3f4;display:flex;justify-content:space-between;font-size:14px;}
    .sugg-item:last-child{border-bottom:0;}
    .meta{font-size:11px;color:#5f6368;margin-left:8px;white-space:nowrap;}
    .chat-toggle{position:fixed;bottom:10px;left:10px;z-index:2000;}
    .popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border:1px solid #dadce0;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.2);padding:20px;z-index:1000;display:none;}
    .popup input{width:100%;padding:8px;font-size:14px;margin-bottom:10px;}
    .popup button{padding:6px 12px;font-size:14px;}
    .overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.3);z-index:999;display:none;}
    .top-links {
      margin-top:8px;
      margin-left:16px;
      font-size:12px;
      color:#70757a;
      text-align:left;
    }
    .top-links a {
      color:inherit;
      text-decoration:none;
      margin-right:16px;
      cursor:pointer;
    }
    .top-links a:hover {
      text-decoration:underline;
    }
    .footer-bar {
      width: 100%;
      position: fixed;
      left: 0;
      bottom: 0;
      background: #f2f2f2;
      color: #70757a;
      font-size: 14px;
      z-index: 100;
      box-shadow: 0 -1px 4px rgba(0,0,0,0.04);
    }
    .footer-top {
      padding: 12px 32px;
      border-bottom: 1px solid #e4e4e4;
      background: #f2f2f2;
      text-align: left;
    }
    .footer-bottom {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 32px;
      background: #f2f2f2;
    }
    .footer-bottom-left, .footer-bottom-right {
      display: flex;
      gap: 18px;
    }
    .footer-link {
      color: inherit;
      text-decoration: none;
      cursor: pointer;
      font-size: 14px;
    }
    .footer-link:hover {
      text-decoration: underline;
    }
    #koreaBtn {
      cursor: pointer;
    }
    .search-buttons {
      text-align: center;
      margin-top: 20px;
    }
    .search-buttons button {
      background-color: #f8f9fa;
      border: 1px solid #f8f9fa;
      border-radius: 4px;
      color: #3c4043;
      cursor: pointer;
      font-family: arial,sans-serif;
      font-size: 14px;
      margin: 11px 4px;
      padding: 0 16px;
      line-height: 27px;
      height: 36px;
      min-width: 54px;
      text-align: center;
      user-select: none;
    }
    .search-buttons button:hover {
      box-shadow: 0 1px 1px rgba(0,0,0,.1);
      background-color: #f8f9fa;
      border: 1px solid #dadce0;
      color: #202124;
    }
    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 1px solid #dadce0;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      padding: 20px;
      z-index: 1000;
      display: none;
      max-width: 400px;
      width: 90%;
    }
    .popup-header {
      border-bottom: 1px solid #e8eaed;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }
    .popup-header h3 {
      margin: 0;
      font-size: 18px;
      color: #202124;
    }
    .popup-buttons {
      text-align: right;
      margin-top: 15px;
    }
    .help-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 1px solid #dadce0;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      padding: 20px;
      z-index: 1001;
      max-width: 500px;
      width: 90%;
    }
    .help-content ul {
      padding-left: 20px;
      color: #3c4043;
    }
    .help-checkbox {
      margin: 15px 0;
    }
    .help-close-btn {
      background-color: #1a73e8;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      float: right;
    }
    .admin-popup, .admin-dashboard, .reset-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 1px solid #dadce0;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      padding: 20px;
      z-index: 1000;
      display: none;
      max-width: 400px;
      width: 90%;
    }
    .admin-dashboard {
      max-width: 600px;
    }
    .user-list {
      max-height: 200px;
      overflow-y: auto;
    }
    .user-item {
      padding: 8px;
      border-bottom: 1px solid #e8eaed;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .user-item:last-child {
      border-bottom: none;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div style="display: flex; align-items: center; gap: 16px;">
      <div class="gmail-link">Google ì •ë³´</div>
      <div class="gmail-link">ìŠ¤í† ì–´</div>
    </div>
    <div style="display: flex; align-items: center; gap: 16px;">
      <div class="gmail-link">ì´ë¯¸ì§€</div>
      <div class="gmail-link">Gmail</div>
      <div id="profile" class="profile" title="ë‹‰ë„¤ì„ ì„¤ì •">N</div>
    </div>
  </div>
  <div class="main">
    <div class="logo"><img src="https://www.google.com/images/branding/googlelogo/1x/googlelogo_color_272x92dp.png" alt="Google"></div>
    <div class="searchbox">
      <form class="searchform" onsubmit="return false;">
        <input id="q" type="text" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" autocomplete="off" />
      </form>
      <div class="suggestions" id="feed" style="display:none;">
        <div class="sugg-header">ì—°ê´€ ê²€ìƒ‰ì–´</div>
      </div>
    </div>
    <div class="search-buttons" id="searchButtons" style="display:none;">
      <button type="button" id="googleSearch">Google ê²€ìƒ‰</button>
      <button type="button" id="feelingLucky">I'm Feeling Lucky</button>
    </div>
  </div>

  <div class="overlay" id="overlay"></div>
  <div class="popup" id="popup">
    <div class="popup-header">
      <h3>ë‹‰ë„¤ì„ ì„¤ì •</h3>
      <button type="button" id="closePopup" style="background: none; border: none; font-size: 18px; cursor: pointer; float: right;" title="ë‹«ê¸°">&times;</button>
    </div>
    <div class="popup-body">
      <input type="text" id="nickInput" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" style="width: 100%; padding: 12px; border: 1px solid #dadce0; border-radius: 4px; font-size: 14px; margin: 15px 0; box-sizing: border-box;">
      <div class="popup-buttons">
        <button id="saveNick" style="background-color: #1a73e8; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 8px;">ì €ì¥</button>
        <button id="cancelNick" style="background-color: #f8f9fa; color: #3c4043; border: 1px solid #dadce0; padding: 8px 16px; border-radius: 4px; cursor: pointer;">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>
  
  <!-- ì‚¬ìš©ë°©ë²• ì•ˆë‚´ íŒì—… -->
  <div class="help-popup" id="helpPopup" style="display:none;">
    <div class="help-content">
      <h3>ğŸŒŸ ì‚¬ìš©ë°©ë²• ì•ˆë‚´</h3>
      <ul>
        <li>ê¸°ë³¸ ìƒíƒœì—ì„œëŠ” êµ¬ê¸€ ê²€ìƒ‰ì°½ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤</li>
        <li>í•˜ë‹¨ <strong>ëŒ€í•œë¯¼êµ­</strong> ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ì¼ë°˜ëª¨ë“œì™€ ì±„íŒ…ëª¨ë“œ ê°„ ì „í™˜ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
        <li><strong>ì•½ê´€</strong>ì„ í´ë¦­í•˜ë©´ ëª¨ë“  ëŒ€í™”ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤</li>
        <li>ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ì„ í´ë¦­í•˜ë©´ í˜„ì¬ ì ‘ì†ìë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        <li>ì‚¬ìš© ì¤‘ ì„ ìƒë‹˜ì´ ì˜¤ì‹¤ ê²½ìš° <strong>Control + R</strong>ë¥¼ ëˆŒëŸ¬ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë¹ ë¥´ê²Œ ì¼ë°˜ëª¨ë“œë¡œ ì „í™˜í•˜ì„¸ìš”.</li>
      </ul>
      <div class="help-checkbox">
        <input type="checkbox" id="dontShowAgain"> ë‹¤ì‹œ ë³´ì§€ ì•Šê¸°
      </div>
      <button id="closeHelp" class="help-close-btn">í™•ì¸</button>
    </div>
  </div>

  <!-- ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ íŒì—… (í˜„ì¬ ì ‘ì†ì ëª©ë¡) -->
  <div class="admin-popup" id="privacyPopup" style="display:none;">
    <div class="popup-header">
      <h3>í˜„ì¬ ì ‘ì†ì</h3>
      <button type="button" id="closePrivacy" style="background: none; border: none; font-size: 18px; cursor: pointer; float: right;" title="ë‹«ê¸°">&times;</button>
    </div>
    <div class="popup-body">
      <div id="connectedUsers">
        <p>í˜„ì¬ ì ‘ì†ì¤‘ì¸ ì‚¬ìš©ì ëª©ë¡ì„ ë¡œë”©ì¤‘ì…ë‹ˆë‹¤...</p>
      </div>
      <div class="popup-buttons">
        <button id="refresUsers" style="background-color: #1a73e8; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">ìƒˆë¡œê³ ì¹¨</button>
      </div>
    </div>
  </div>

  <!-- ê´€ë¦¬ì ì¸ì¦ íŒì—… -->
  <div class="admin-popup" id="adminPopup" style="display:none;">
    <div class="popup-header">
      <h3>ê´€ë¦¬ì ì¸ì¦</h3>
      <button type="button" id="closeAdminPopup" style="background: none; border: none; font-size: 18px; cursor: pointer; float: right;" title="ë‹«ê¸°">&times;</button>
    </div>
    <div class="popup-body">
      <input type="password" id="adminPasswordInput" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" style="width: 100%; padding: 12px; border: 1px solid #dadce0; border-radius: 4px; font-size: 14px; margin: 15px 0; box-sizing: border-box;">
      <div class="popup-buttons">
        <button id="adminLogin" style="background-color: #1a73e8; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 8px;">ë¡œê·¸ì¸</button>
        <button id="cancelAdmin" style="background-color: #f8f9fa; color: #3c4043; border: 1px solid #dadce0; padding: 8px 16px; border-radius: 4px; cursor: pointer;">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

  <!-- ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ -->
  <div class="admin-dashboard" id="adminDashboard" style="display:none;">
    <div class="popup-header">
      <h3>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h3>
      <button type="button" id="closeDashboard" style="background: none; border: none; font-size: 18px; cursor: pointer; float: right;" title="ë‹«ê¸°">&times;</button>
    </div>
    <div class="popup-body">
      <div id="adminContent">
        <div id="resetCounter" style="margin-bottom: 20px; padding: 12px; background: #f8f9fa; border-radius: 4px; text-align: center;">
          <strong>ë‹¤ìŒ ìë™ ì´ˆê¸°í™”ê¹Œì§€:</strong> <span id="countdownTime" style="color: #ea4335; font-weight: bold;">ê³„ì‚° ì¤‘...</span>
        </div>
        <!-- ê´€ë¦¬ì ê¸°ëŠ¥ë“¤ì´ ë“¤ì–´ê°ˆ ì˜ˆì • -->
      </div>
      <div class="popup-buttons">
        <button id="closeAdminDashboard" style="background-color: #1a73e8; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ì•½ê´€ ë¦¬ì…‹ í™•ì¸ íŒì—… -->
  <div class="reset-popup" id="resetPopup" style="display:none;">
    <div class="popup-header">
      <h3>ëŒ€í™” ì´ˆê¸°í™”</h3>
      <button type="button" id="closeResetPopup" style="background: none; border: none; font-size: 18px; cursor: pointer; float: right;" title="ë‹«ê¸°">&times;</button>
    </div>
    <div class="popup-body">
      <p>ëª¨ë“  ëŒ€í™”ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
      <p style="font-size: 12px; color: #5f6368; margin-top: 8px;">ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
      <div class="popup-buttons">
        <button id="confirmReset" style="background-color: #ea4335; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 8px;">ì´ˆê¸°í™”</button>
        <button id="cancelReset" style="background-color: #f8f9fa; color: #3c4043; border: 1px solid #dadce0; padding: 8px 16px; border-radius: 4px; cursor: pointer;">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>


  <div class="footer-bar">
    <div class="footer-top">
      <span id="koreaBtn" class="footer-link">ëŒ€í•œë¯¼êµ­</span>
    </div>
    <div class="footer-bottom">
      <div class="footer-bottom-left">
        <a href="#" id="adsBtn" class="footer-link">ê´‘ê³ </a>
        <a href="#" class="footer-link">ë¹„ì¦ˆë‹ˆìŠ¤</a>
        <a href="#" class="footer-link">ê²€ìƒ‰ì˜ ì›ë¦¬</a>
      </div>
      <div class="footer-bottom-right">
        <a href="#" id="privacyBtn" class="footer-link">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
        <a href="#" id="termsBtn" class="footer-link">ì•½ê´€</a>
        <a href="#" id="settingBtn" class="footer-link">ì„¤ì •</a>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCcFnqI0ASZgyjmFs-W9w8NZNeGyxGiOU0",
      authDomain: "fake-chat-6a215.firebaseapp.com",
      projectId: "fake-chat-6a215",
      storageBucket: "fake-chat-6a215.firebasestorage.app",
      messagingSenderId: "692426402317",
      appId: "1:692426402317:web:d7789f7a6bf10e15650344"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const messagesRef = collection(db, 'messages');

    async function sendMessage(text, nick) {
      try {
        const docRef = await addDoc(messagesRef, {
          text: text,
          nick: nick,
          t: Date.now()
        });
        console.log("ë©”ì‹œì§€ ì¶”ê°€ë¨:", docRef.id);   // ë¡œê·¸ í™•ì¸ìš©
      } catch (e) {
        console.error("ë©”ì‹œì§€ ì¶”ê°€ ì‹¤íŒ¨:", e);
      }
    }

    // ê¸°ì¡´ footer ê´€ë ¨ DOM ì œê±°, ìƒˆ í•˜ë‹¨ë°” DOM ì°¸ì¡°
    const koreaBtn = document.getElementById('koreaBtn');
    const settingBtn = document.getElementById('settingBtn');

    // ì±„íŒ…ëª¨ë“œ ê¸°ë³¸ êº¼ì§
    let chatMode = false;
    let koreaOn = false;

    function updateKoreaBtn(){
      koreaBtn.textContent = koreaOn ? 'ëŒ€í•œë¯¼êµ­*' : 'ëŒ€í•œë¯¼êµ­';
    }
    updateKoreaBtn();

    koreaBtn.addEventListener('click',()=>{
      koreaOn = !koreaOn;
      chatMode = koreaOn;
      updateKoreaBtn();
      render();
    });

    // ì„¤ì • ë²„íŠ¼ í´ë¦­ ì‹œ ê´€ë¦¬ì ì¸ì¦ íŒì—… í‘œì‹œ
    settingBtn.addEventListener('click', () => {
      document.getElementById('adminPopup').style.display = 'block';
      document.getElementById('overlay').style.display = 'block';
      document.getElementById('adminPasswordInput').focus();
    });

    // ì•½ê´€ ë²„íŠ¼ í´ë¦­ ì‹œ ë¦¬ì…‹ í™•ì¸ íŒì—…
    document.getElementById('termsBtn').addEventListener('click', () => {
      document.getElementById('resetPopup').style.display = 'block';
      document.getElementById('overlay').style.display = 'block';
    });

    // ë‹‰ë„¤ì„ ê´€ë ¨ ì½”ë“œ
    const profile = document.getElementById('profile');
    const popup = document.getElementById('popup');
    const overlay = document.getElementById('overlay');
    const nickInput = document.getElementById('nickInput');
    const saveNick = document.getElementById('saveNick');
    const cancelNick = document.getElementById('cancelNick');

    let nickname = localStorage.getItem('nick') || 'User';
    updateProfileDisplay();

    function updateProfileDisplay(){
      if(nickname && nickname.length > 0){
        profile.textContent = nickname[0].toUpperCase();
        profile.title = `í˜„ì¬ ë‹‰ë„¤ì„: ${nickname}`;
      } else {
        profile.textContent = 'U';
        profile.title = 'ë‹‰ë„¤ì„ ì„¤ì •';
      }
    }

    // feed, q, messages ë³€ìˆ˜ ì„ ì–¸ ì¶”ê°€
    const q = document.getElementById('q');
    const feed = document.getElementById('feed');
    let messages = [];

    function render(){
      const searchButtons = document.getElementById('searchButtons');
      if(!chatMode){
        feed.style.display = 'none';
        searchButtons.style.display = 'block';
        return;
      }
      feed.style.display = '';
      searchButtons.style.display = 'none';
      feed.innerHTML = '<div class="sugg-header">ì—°ê´€ ê²€ìƒ‰ì–´</div>';
      messages.forEach(m=>{
        const el=document.createElement('div');
        el.className='sugg-item';
        el.innerHTML='<div>'+m.text+'</div><div class="meta">'+m.nick+' Â· '+new Date(m.t).toLocaleTimeString()+'</div>';
        feed.appendChild(el);
      });
    }

    q.addEventListener('keydown', e=>{
      if(e.key==='Enter' && !e.isComposing){
        e.preventDefault();
        const text=q.value.trim();
        if(chatMode){
          if(text){
            sendMessage(text, nickname);
          }
        } else {
          if(text){
            const url = 'https://www.google.com/search?q=' + encodeURIComponent(text);
            window.location.href = url;
          }
        }
        q.value='';
      }
    });

    // ê²€ìƒ‰ ë²„íŠ¼ë“¤
    document.getElementById('googleSearch').addEventListener('click', ()=>{
      const text=q.value.trim();
      if(text){
        const url = 'https://www.google.com/search?q=' + encodeURIComponent(text);
        window.location.href = url;
      }
    });
    
    document.getElementById('feelingLucky').addEventListener('click', ()=>{
      const text=q.value.trim();
      if(text){
        const url = 'https://www.google.com/search?q=' + encodeURIComponent(text) + '&btnI=I%27m+Feeling+Lucky';
        window.location.href = url;
      }
    });

    // Firestore ë©”ì‹œì§€ ì „ì²´ ì‚­ì œ
    async function resetAllMessages(){
      const qSnap = await getDocs(collection(db, 'messages'));
      const batch = [];
      qSnap.forEach(docu=>{
        batch.push(deleteDoc(doc(db, 'messages', docu.id)));
      });
      await Promise.all(batch);
      
      // System ë©”ì‹œì§€ ì¶”ê°€
      if(chatMode) {
        await sendMessage('ë©”ì‹œì§€ê°€ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤.', 'System');
      }
    }

    // ì‹¤ì‹œê°„ ë©”ì‹œì§€ êµ¬ë…
    const qSnap = query(messagesRef, orderBy('t', 'desc'), limit(50));
    onSnapshot(qSnap, snapshot => {
      messages = [];
      snapshot.forEach(doc => {
        messages.push(doc.data());
      });
      render();
    });

    // ë‹‰ë„¤ì„ íŒì—…
    profile.addEventListener('click',()=>{
      nickInput.value = nickname;
      popup.style.display = 'block';
      overlay.style.display = 'block';
      nickInput.focus();
    });

    // ë‹‰ë„¤ì„ ì…ë ¥ í•„ë“œì—ì„œ ì—”í„°í‚¤ ì²˜ë¦¬
    nickInput.addEventListener('keypress', (e) => {
      if(e.key === 'Enter') {
        e.preventDefault();
        const newNick = nickInput.value.trim();
        if(newNick){
          nickname=newNick;
          localStorage.setItem('nick',nickname);
          updateProfileDisplay();
        }
        closePopup();
      }
    });

    saveNick.addEventListener('click',()=>{
      const newNick = nickInput.value.trim();
      if(newNick){
        nickname=newNick;
        localStorage.setItem('nick',nickname);
        updateProfileDisplay();
      }
      closePopup();
    });

    cancelNick.addEventListener('click',closePopup);

    // ë‹‰ë„¤ì„ íŒì—… X ë²„íŠ¼
    document.getElementById('closePopup').addEventListener('click', closePopup);

    function closePopup(){
      popup.style.display = 'none';
      overlay.style.display = 'none';
    }

    // ì‚¬ìš©ë°©ë²• ì•ˆë‚´ ê¸°ëŠ¥ - 1ì‹œê°„ ë™ì•ˆ ì•ˆë³´ê¸°
    function showHelpPopup() {
      const dontShowAgainTime = localStorage.getItem('dontShowHelp');
      const now = Date.now();
      const oneHour = 60 * 60 * 1000; // 1ì‹œê°„
      
      if (!dontShowAgainTime || (now - parseInt(dontShowAgainTime)) > oneHour) {
        document.getElementById('helpPopup').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
      }
    }

    // ë„ì›€ë§ ê´€ë ¨ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById('closeHelp').addEventListener('click', () => {
      const dontShow = document.getElementById('dontShowAgain').checked;
      if (dontShow) {
        localStorage.setItem('dontShowHelp', Date.now().toString());
      }
      document.getElementById('helpPopup').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë„ì›€ë§ í‘œì‹œ
    if (window.performance && window.performance.navigation.type === window.performance.navigation.TYPE_RELOAD) {
      showHelpPopup();
    }

    // ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ ë²„íŠ¼ - í˜„ì¬ ì ‘ì†ì íŒì—…
    document.getElementById('privacyBtn').addEventListener('click', (e) => {
      e.preventDefault();
      loadConnectedUsers();
      document.getElementById('privacyPopup').style.display = 'block';
      document.getElementById('overlay').style.display = 'block';
    });

    // ìë™ ì´ˆê¸°í™”ì„ ìœ„í•œ ë³€ìˆ˜ (3ë¶„ = 180000ms)
    let autoResetInterval = setInterval(async () => {
      await resetAllMessages();
      alert('3ë¶„ì´ ì§€ë‚˜ ìë™ìœ¼ë¡œ ëŒ€í™”ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
      updateResetCountdown();
    }, 180000);

    let resetStartTime = Date.now();

    // ì´ˆê¸°í™”ê¹Œì§€ ë‚¨ì€ ì‹œê°„ ì—…ë°ì´íŠ¸
    function updateResetCountdown() {
      resetStartTime = Date.now();
    }

    function startResetCountdown() {
      setInterval(() => {
        const now = Date.now();
        const elapsed = now - resetStartTime;
        const remaining = 180000 - elapsed;
        
        if (remaining <= 0) {
          document.getElementById('countdownTime').textContent = 'ìë™ ì´ˆê¸°í™” ì¤‘...';
          return;
        }
        
        const minutes = Math.floor(remaining / 60000);
        const seconds = Math.floor((remaining % 60000) / 1000);
        document.getElementById('countdownTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}ë¶„`;
      }, 1000);
    }

    // ê´€ë¦¬ì ì¸ì¦ ê´€ë ¨ ì´ë²¤íŠ¸
    document.getElementById('adminLogin').addEventListener('click', () => {
      const password = document.getElementById('adminPasswordInput').value;
      if (password === '0429') {
        document.getElementById('adminPopup').style.display = 'none';
        document.getElementById('adminDashboard').style.display = 'block';
        document.getElementById('adminPasswordInput').value = '';
        
        // ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
        startResetCountdown();
      } else {
        alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
      }
    });

    // ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ë‹«ê¸°
    document.getElementById('closeDashboard').addEventListener('click', () => {
      document.getElementById('adminDashboard').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
    });

    document.getElementById('closeAdminDashboard').addEventListener('click', () => {
      document.getElementById('adminDashboard').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
    });

    // ê´€ë¦¬ì ì¸ì¦ íŒì—… ë‹«ê¸°
    document.getElementById('closeAdminPopup').addEventListener('click', () => {
      document.getElementById('adminPopup').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
    });

    document.getElementById('cancelAdmin').addEventListener('click', () => {
      document.getElementById('adminPopup').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
    });

    // ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ íŒì—… ë‹«ê¸°
    document.getElementById('closePrivacy').addEventListener('click', () => {
      document.getElementById('privacyPopup').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
    });

    document.getElementById('refresUsers').addEventListener('click', () => {
      loadConnectedUsers();
    });

    // í˜„ì‹¤ì ì¸ ì ‘ì†ì ì •ë³´ ë¡œë“œ í•¨ìˆ˜ (êµ­ê°€ë³„ IP ëŒ€ì‘)
    async function loadConnectedUsers() {
      const userContainer = document.getElementById('connectedUsers');
      userContainer.innerHTML = '<p>í˜„ì¬ ì ‘ì†ì¤‘ì¸ ì‚¬ìš©ì ëª©ë¡ì„ ë¡œë”©ì¤‘ì…ë‹ˆë‹¤...</p>';
      
      try {
        // í˜„ì¬ ì‚¬ìš©ì IP ì •ë³´ íšë“ (ê°„ì†Œí™”ëœ ë°©ë²•)
        const getCurrentIP = async () => {
          try {
            const response = await fetch('https://api.ipify.org?format=json');
            const data = await response.json();
            return data.ip;
          } catch {
            // IP í™•ì¸ ì‹¤íŒ¨ ì‹œ ë¡œì»¬IP ì‹œë®¬ë ˆì´ì…˜
            return '127.0.0.1';
          }
        };
        
        const userIP = await getCurrentIP();
        const allUsers = {};
        
        // ëª¨ë“  ë©”ì‹œì§€ì—ì„œ ê³ ìœ  ì‚¬ìš©ìë“¤ì„ ìˆ˜ì§‘
        messages.forEach(msg => {
          if (msg.nick && msg.nick !== 'System') {
            if (!allUsers[msg.nick]) {
              allUsers[msg.nick] = {
                name: msg.nick,
                lastSeen: msg.t,
                ip: userIP
              };
            }
          }
        });
        
        // í˜„ì¬ ë¡œì»¬ ì‚¬ìš©ì ì¶”ê°€
        allUsers[nickname] = {
          name: `${nickname} (í˜„ì¬)`,
          lastSeen: Date.now(),
          ip: userIP
        };
        
        // ì ‘ì†ìë“¤ì„ ë§ˆì§€ë§‰ í™œë™ ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬
        const userItems = Object.values(allUsers)
          .sort((a, b) => b.lastSeen - a.lastSeen)
          .map(user => `
            <div class="user-item">
              <span>${user.name}</span>
              <span style="font-size: 12px; color: #5f6368;">${user.ip}</span>
              <span style="font-size: 11px; color: #9aa0a6; margin-left: 8px;">${new Date(user.lastSeen).toLocaleTimeString()}</span>
            </div>
          `).join('');
        
        userContainer.innerHTML = `
          <div class="user-list">
            ${userItems || '<div class="user-item"><span style="color: #5f6368;">í˜„ì¬ ì ‘ì†ì ì—†ìŒ</span></div>'}
          </div>
        `;
        
      } catch (error) {
        console.error('ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        userContainer.innerHTML = '<div class="user-item"><span style="color: #ea4335;">ì‚¬ìš©ì ëª©ë¡ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span></div>';
      }
    }

    // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ì°½ì—ì„œ ì—”í„°í‚¤ë„ ì§€ì›
    document.getElementById('adminPasswordInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('adminLogin').click();
      }
    });

    // ì•½ê´€ ë¦¬ì…‹ íŒì—… ì´ë²¤íŠ¸ë“¤
    document.getElementById('confirmReset').addEventListener('click', async () => {
      await resetAllMessages();
      document.getElementById('resetPopup').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
      alert('ëª¨ë“  ëŒ€í™”ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
    });

    document.getElementById('cancelReset').addEventListener('click', () => {
      document.getElementById('resetPopup').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
    });

    document.getElementById('closeResetPopup').addEventListener('click', () => {
      document.getElementById('resetPopup').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
    });

    // ê´‘ê³  ì•ˆë‚´ íŒì—… ì´ë²¤íŠ¸ë“¤ - ì‚¬ìš©ë²• ì•ˆë‚´ í‘œì‹œ
    document.getElementById('adsBtn').addEventListener('click', (e) => {
      e.preventDefault();
      // ë‹¤ì‹œë³´ì§€ì•Šê¸° ìƒíƒœ í•´ì œ
      localStorage.removeItem('dontShowHelp');
      // ì‚¬ìš©ë²• ì•ˆë‚´ íŒì—… í‘œì‹œ
      document.getElementById('helpPopup').style.display = 'block';
      document.getElementById('overlay').style.display = 'block';
    });


    render();
  </script>
</body>
</html>